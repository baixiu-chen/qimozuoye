{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "2ca08fd4-c508-4351-9c79-1d48af79669f",
   "metadata": {},
   "source": [
    "è®°è´¦æœ¬ç½‘ç«™æ­å»º"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ae3373ad-6aeb-4229-b621-62e17039d66a",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "from datetime import datetime\n",
    "import streamlit as st\n",
    "from openai import OpenAI\n",
    "\n",
    "# æ„é€  client\n",
    "client = OpenAI(\n",
    "    api_key=st.secrets[\"HUNYUAN_API_KEY\"],  # ä» secrets.toml è¯»å–å¯†é’¥\n",
    "    base_url=\"https://api.hunyuan.cloud.tencent.com/v1\",\n",
    ")\n",
    "\n",
    "# è®¾ç½®é¡µé¢\n",
    "st.set_page_config(page_title=\"æœˆå…‰æ—è®°è´¦æœ¬\", page_icon=\"ğŸ’°\", layout=\"wide\")\n",
    "\n",
    "# åˆå§‹åŒ–session_state\n",
    "if 'transactions' not in st.session_state:\n",
    "    st.session_state.transactions = pd.DataFrame(columns=[\n",
    "        'æ—¥æœŸ', 'é‡‘é¢', 'ç±»åˆ«', 'æ”¯ä»˜æ–¹å¼', 'å¤‡æ³¨'\n",
    "    ])\n",
    "\n",
    "# ä¾§è¾¹æ  - ç”¨æˆ·ä¿¡æ¯\n",
    "with st.sidebar:\n",
    "    st.header(\"ç”¨æˆ·ç”»åƒ\")\n",
    "    gender = st.radio(\"æ€§åˆ«\", ('ç”·', 'å¥³', 'å…¶ä»–'))\n",
    "    age = st.slider(\"å¹´é¾„\", 18, 40, 20)\n",
    "    major = st.selectbox(\"ä¸“ä¸š\", ('ç†å·¥', 'æ–‡å²', 'ç»ç®¡', 'è‰ºæœ¯', 'å…¶ä»–'))\n",
    "    \n",
    "    st.divider()\n",
    "    is_finance = st.checkbox(\"æ˜¯å¦ç†è´¢\")\n",
    "    is_accounting = st.checkbox(\"æ˜¯å¦è®°è´¦\")\n",
    "    \n",
    "    if st.button(\"ç”Ÿæˆæœˆå…‰åˆ†ææŠ¥å‘Š\"):\n",
    "        analyze_moonlight()\n",
    "\n",
    "# ä¸»ç•Œé¢\n",
    "st.title(\"ğŸ’° æœˆå…‰æ—è®°è´¦æœ¬\")\n",
    "st.caption(\"ç ”ç©¶æ˜¾ç¤ºï¼šæœˆå…‰ç°è±¡ä¸ç†è´¢/è®°è´¦ä¹ æƒ¯ç›¸å…³æ€§é«˜äºäººå£ç»Ÿè®¡å­¦å› ç´ \")\n",
    "\n",
    "# è®°è´¦è¡¨å•\n",
    "with st.form(\"è®°è´¦è¡¨å•\", clear_on_submit=True):\n",
    "    cols = st.columns(3)\n",
    "    with cols[0]:\n",
    "        date = st.date_input(\"æ—¥æœŸ\", datetime.now())\n",
    "    with cols[1]:\n",
    "        amount = st.number_input(\"é‡‘é¢\", min_value=0.0, step=0.01)\n",
    "    with cols[2]:\n",
    "        category = st.selectbox(\"ç±»åˆ«\", (\n",
    "            'é¤é¥®', 'æœé¥°', 'å¨±ä¹', 'äº¤é€š', 'å­¦ä¹ ', 'ä½å®¿', 'åŒ»ç–—', 'å…¶ä»–'\n",
    "        ))\n",
    "    \n",
    "    cols = st.columns(2)\n",
    "    with cols[0]:\n",
    "        payment = st.selectbox(\"æ”¯ä»˜æ–¹å¼\", ('æ”¯ä»˜å®', 'å¾®ä¿¡', 'ç°é‡‘', 'é“¶è¡Œå¡'))\n",
    "    with cols[1]:\n",
    "        note = st.text_input(\"å¤‡æ³¨\")\n",
    "    \n",
    "    if st.form_submit_button(\"æ·»åŠ è®°å½•\"):\n",
    "        new_record = pd.DataFrame([[\n",
    "            date, amount, category, payment, note\n",
    "        ]], columns=st.session_state.transactions.columns)\n",
    "        \n",
    "        st.session_state.transactions = pd.concat(\n",
    "            [st.session_state.transactions, new_record],\n",
    "            ignore_index=True\n",
    "        )\n",
    "        st.success(\"è®°å½•å·²æ·»åŠ ï¼\")\n",
    "\n",
    "# æ˜¾ç¤ºæ•°æ®è¡¨\n",
    "if not st.session_state.transactions.empty:\n",
    "    st.subheader(\"æ¶ˆè´¹è®°å½•\")\n",
    "    st.dataframe(\n",
    "        st.session_state.transactions.sort_values('æ—¥æœŸ', ascending=False),\n",
    "        hide_index=True,\n",
    "        use_container_width=True\n",
    "    )\n",
    "    \n",
    "    # æ¶ˆè´¹åˆ†æ\n",
    "    st.subheader(\"æ¶ˆè´¹åˆ†æ\")\n",
    "    tab1, tab2, tab3 = st.tabs([\"è¶‹åŠ¿åˆ†æ\", \"ç±»åˆ«åˆ†æ\", \"æœˆå…‰é¢„æµ‹\"])\n",
    "    \n",
    "    with tab1:\n",
    "        fig, ax = plt.subplots()\n",
    "        daily_spending = st.session_state.transactions.groupby('æ—¥æœŸ')['é‡‘é¢'].sum()\n",
    "        sns.lineplot(data=daily_spending, ax=ax)\n",
    "        ax.set_title(\"æ¯æ—¥æ¶ˆè´¹è¶‹åŠ¿\")\n",
    "        st.pyplot(fig)\n",
    "    \n",
    "    with tab2:\n",
    "        col1, col2 = st.columns(2)\n",
    "        with col1:\n",
    "            st.write(\"#### æ¶ˆè´¹ç±»åˆ«å æ¯”\")\n",
    "            category_sum = st.session_state.transactions.groupby('ç±»åˆ«')['é‡‘é¢'].sum()\n",
    "            st.dataframe(category_sum.sort_values(ascending=False))\n",
    "        \n",
    "        with col2:\n",
    "            fig, ax = plt.subplots()\n",
    "            category_sum.plot.pie(autopct=\"%.1f%%\", ax=ax)\n",
    "            st.pyplot(fig)\n",
    "    \n",
    "    with tab3:\n",
    "        st.warning(\"æ­£åœ¨å¼€å‘ä¸­...\")\n",
    "        st.write(\"åŸºäºæ‚¨çš„ç ”ç©¶æ•°æ®ï¼Œå°†é¢„æµ‹æœˆå…‰æ¦‚ç‡\")\n",
    "\n",
    "# æœˆå…‰åˆ†æå‡½æ•°\n",
    "def analyze_moonlight():\n",
    "    st.sidebar.success(\"åˆ†æå®Œæˆï¼\")\n",
    "    conclusion = f\"\"\"\n",
    "    ### æœˆå…‰è¡Œä¸ºåˆ†ææŠ¥å‘Šï¼ˆåŸºäºæ‚¨çš„ç”»åƒï¼‰\n",
    "    - **åŸºæœ¬ç‰¹å¾**ï¼š{age}å² {gender}æ€§ {major}ä¸“ä¸š\n",
    "    - **è´¢åŠ¡ä¹ æƒ¯**ï¼š{'æœ‰' if is_finance else 'æ— '}ç†è´¢ | {'æœ‰' if is_accounting else 'æ— '}è®°è´¦\n",
    "    \n",
    "    ğŸ“Š **ç ”ç©¶å‘ç°**ï¼š\n",
    "    1. æ‚¨çš„æœˆå…‰é£é™©ä¸»è¦ä¸{'ç†è´¢ä¹ æƒ¯' if is_finance else 'æ¶ˆè´¹ç»“æ„'}ç›¸å…³\n",
    "    2. {'è®°è´¦' if is_accounting else 'ä¸è®°è´¦'}ä¼šä½¿æœˆå…‰æ¦‚ç‡{'é™ä½30%' if is_accounting else 'å¢åŠ 45%'}\n",
    "    3. å»ºè®®å…³æ³¨{classification_advice()}\n",
    "    \"\"\"\n",
    "    st.sidebar.markdown(conclusion)\n",
    "\n",
    "def classification_advice():\n",
    "    if not is_accounting and not is_finance:\n",
    "        return \"éå¿…è¦æ¶ˆè´¹ï¼ˆç‰¹åˆ«æ˜¯å¨±ä¹å’Œæœé¥°ç±»ï¼‰\"\n",
    "    elif is_accounting and not is_finance:\n",
    "        return \"ç†è´¢å·¥å…·çš„ä½¿ç”¨ï¼ˆå¦‚è´§å¸åŸºé‡‘ï¼‰\"\n",
    "    else:\n",
    "        return \"æ¶ˆè´¹ç»“æ„çš„ä¼˜åŒ–ï¼ˆå¿…è¦/éå¿…è¦æ”¯å‡ºæ¯”ï¼‰\"\n",
    "\n",
    "# æ•°æ®å¯¼å‡º\n",
    "if not st.session_state.transactions.empty:\n",
    "    st.download_button(\n",
    "        label=\"å¯¼å‡ºæ¶ˆè´¹è®°å½•\",\n",
    "        data=st.session_state.transactions.to_csv(index=False).encode('utf-8'),\n",
    "        file_name=f\"æ¶ˆè´¹è®°å½•_{datetime.now().strftime('%Y%m%d')}.csv\",\n",
    "        mime=\"text/csv\"\n",
    "    )\n",
    "\n",
    "# è°ƒç”¨æ··å…ƒAPIï¼ˆç¤ºä¾‹ï¼‰\n",
    "try:\n",
    "    completion = client.chat.completions.create(\n",
    "        model=\"hunyuan-turbos-latest\",\n",
    "        messages=[\n",
    "            {\"role\": \"system\", \"content\": \"### å®šä½ï¼šè¯­ä¹‰æ­§è§†åˆ†æä¸“å®¶\\n ### ä»»åŠ¡ï¼šè¯·å¯¹ç”¨æˆ·è¾“å…¥çš„å¥å­è¿›è¡Œæ­§è§†æ€§åˆ†æï¼Œå¹¶ç”¨ 1 åˆ° 5 ä¹‹é—´çš„æ•°å­—è¡¨ç¤ºå…¶æ­§è§†ç¨‹åº¦ã€‚1 è¡¨ç¤ºæ²¡æœ‰æ­§è§†ï¼Œ5 è¡¨ç¤ºæä¸ºæ­§è§†ã€‚\\n ###è¾“å‡º ï¼šåªè¾“å‡ºæ•°å­—ï¼Œä¸éœ€è¦é¢å¤–è§£é‡Šã€‚\"},\n",
    "            {\"role\": \"user\", \"content\": \"ä½ ä»Šå¤©åšçš„äº‹æƒ…æ¯”çŒªè¿˜è ¢\"}\n",
    "        ],\n",
    "        extra_body={\"enable_enhancement\": True},\n",
    "    )\n",
    "    print(completion.choices[0].message.content)\n",
    "except Exception as e:\n",
    "    st.error(f\"APIè°ƒç”¨å¤±è´¥: {e}\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
